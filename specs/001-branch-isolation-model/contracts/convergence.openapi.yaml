openapi: 3.1.0
info:
  title: Branch Isolation Model - Convergence API
  version: 1.0.0
  description: API for managing convergence (merge) operations in the Echo Portal governed contribution workflow

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Convergence
    description: Convergence/merge operations
  - name: Audit
    description: Audit log operations

paths:
  /convergence:
    get:
      operationId: listConvergenceOperations
      summary: List convergence operations
      description: Returns a paginated list of convergence operations
      tags: [Convergence]
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/ConvergenceStatus'
          description: Filter by status
        - name: branchId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by branch
        - name: publisherId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by publisher
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of convergence operations
          content:
            application/json:
              schema:
                type: object
                required: [data, pagination]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConvergenceSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      operationId: initiateConvergence
      summary: Initiate convergence
      description: Initiates a convergence (merge) operation for an approved branch
      tags: [Convergence]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitiateConvergenceRequest'
      responses:
        '202':
          description: Convergence initiated (async operation)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Convergence'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: User does not have publisher role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Branch not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Branch not in approved state or convergence already in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConvergenceConflictError'

  /convergence/{convergenceId}:
    parameters:
      - name: convergenceId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: getConvergence
      summary: Get convergence details
      description: Returns detailed information about a convergence operation
      tags: [Convergence]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Convergence details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConvergenceDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /convergence/{convergenceId}/status:
    parameters:
      - name: convergenceId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: getConvergenceStatus
      summary: Get convergence status
      description: Returns the current status of a convergence operation (for polling)
      tags: [Convergence]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Convergence status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConvergenceStatusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /convergence/{convergenceId}/rollback:
    parameters:
      - name: convergenceId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      operationId: rollbackConvergence
      summary: Rollback convergence (admin only)
      description: Manually rolls back a convergence operation. Only available for failed operations and requires admin role.
      tags: [Convergence]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  minLength: 10
                  maxLength: 2000
                  description: Reason for rollback
      responses:
        '200':
          description: Rollback completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Convergence'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Convergence cannot be rolled back (e.g., already succeeded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /convergence/validate:
    post:
      operationId: validateConvergence
      summary: Validate convergence (dry run)
      description: Performs convergence validation without actually merging. Useful for checking conflicts.
      tags: [Convergence]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [branchId]
              properties:
                branchId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Validation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResults'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Branch not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /audit:
    get:
      operationId: queryAuditLogs
      summary: Query audit logs
      description: Returns audit logs matching the query criteria
      tags: [Audit]
      security:
        - BearerAuth: []
      parameters:
        - name: action
          in: query
          schema:
            $ref: '#/components/schemas/AuditAction'
          description: Filter by action type
        - name: actorId
          in: query
          schema:
            type: string
          description: Filter by actor ID
        - name: resourceType
          in: query
          schema:
            $ref: '#/components/schemas/ResourceType'
          description: Filter by resource type
        - name: resourceId
          in: query
          schema:
            type: string
          description: Filter by resource ID
        - name: from
          in: query
          schema:
            type: string
            format: date-time
          description: Start of time range
        - name: to
          in: query
          schema:
            type: string
            format: date-time
          description: End of time range
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Audit log entries
          content:
            application/json:
              schema:
                type: object
                required: [data, pagination]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLogEntry'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Audit log access requires admin role or specific resource access
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /branches/{branchId}/history:
    parameters:
      - name: branchId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: getBranchHistory
      summary: Get branch audit history
      description: Returns the complete audit history for a specific branch
      tags: [Audit]
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
      responses:
        '200':
          description: Branch audit history
          content:
            application/json:
              schema:
                type: object
                required: [data, pagination, lineage]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLogEntry'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  lineage:
                    $ref: '#/components/schemas/BranchLineage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ConvergenceStatus:
      type: string
      enum: [pending, validating, merging, succeeded, failed, rolled_back]
      description: Convergence operation status

    Convergence:
      type: object
      required:
        - id
        - branchId
        - publisherId
        - status
        - targetRef
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        branchId:
          type: string
          format: uuid
        publisherId:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/ConvergenceStatus'
        validationResults:
          type: array
          items:
            $ref: '#/components/schemas/ValidationCheck'
        conflictDetected:
          type: boolean
        mergeCommit:
          type: string
          description: SHA of merge commit (on success)
        targetRef:
          type: string
          default: main
        createdAt:
          type: string
          format: date-time
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time

    ConvergenceSummary:
      allOf:
        - $ref: '#/components/schemas/Convergence'
        - type: object
          properties:
            branch:
              type: object
              required: [id, name, slug]
              properties:
                id:
                  type: string
                  format: uuid
                name:
                  type: string
                slug:
                  type: string
            publisher:
              $ref: '#/components/schemas/UserSummary'

    ConvergenceDetail:
      allOf:
        - $ref: '#/components/schemas/ConvergenceSummary'
        - type: object
          properties:
            conflictDetails:
              type: array
              items:
                $ref: '#/components/schemas/ConflictDetail'
            auditTrail:
              type: array
              items:
                $ref: '#/components/schemas/AuditLogEntry'

    ConvergenceStatusResponse:
      type: object
      required: [id, status]
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/ConvergenceStatus'
        progress:
          type: object
          properties:
            currentStep:
              type: string
              enum: [queued, validating, merging, finalizing]
            stepsCompleted:
              type: integer
            totalSteps:
              type: integer
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true

    InitiateConvergenceRequest:
      type: object
      required: [branchId]
      properties:
        branchId:
          type: string
          format: uuid
        skipValidation:
          type: boolean
          default: false
          description: Skip validation checks (admin only, use with caution)
        force:
          type: boolean
          default: false
          description: Force merge even with warnings (admin only)

    ValidationResults:
      type: object
      required: [branchId, valid, checks]
      properties:
        branchId:
          type: string
          format: uuid
        valid:
          type: boolean
          description: Whether all checks passed
        checks:
          type: array
          items:
            $ref: '#/components/schemas/ValidationCheck'
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/ConflictDetail'
        warnings:
          type: array
          items:
            type: object
            required: [code, message]
            properties:
              code:
                type: string
              message:
                type: string

    ValidationCheck:
      type: object
      required: [name, passed]
      properties:
        name:
          type: string
          description: Check name
        passed:
          type: boolean
        message:
          type: string
        severity:
          type: string
          enum: [error, warning, info]

    ConflictDetail:
      type: object
      required: [path, type, description]
      properties:
        path:
          type: string
          description: File path with conflict
        type:
          type: string
          enum: [content, rename, delete]
        description:
          type: string
        resolution:
          type: string
          description: Suggested resolution

    ConvergenceConflictError:
      type: object
      required: [type, title, status, detail]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        conflictReason:
          type: string
          enum:
            - branch_not_approved
            - convergence_in_progress
            - merge_conflict
            - first_wins_blocked
        existingConvergenceId:
          type: string
          format: uuid
          description: ID of existing convergence if one is in progress

    AuditAction:
      type: string
      enum:
        - branch_created
        - branch_updated
        - branch_state_transitioned
        - branch_visibility_changed
        - branch_deleted
        - review_requested
        - review_completed
        - review_comment_added
        - convergence_initiated
        - convergence_succeeded
        - convergence_failed
        - convergence_rolled_back
        - user_created
        - user_updated
        - user_role_changed
        - user_deactivated

    ResourceType:
      type: string
      enum: [branch, review, convergence, user]

    AuditLogEntry:
      type: object
      required:
        - id
        - timestamp
        - action
        - actorId
        - actorType
        - resourceType
        - resourceId
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        action:
          $ref: '#/components/schemas/AuditAction'
        actorId:
          type: string
          description: 'user:uuid or system:name'
        actorType:
          type: string
          enum: [user, system]
        actorIp:
          type: string
        actorUserAgent:
          type: string
        resourceType:
          $ref: '#/components/schemas/ResourceType'
        resourceId:
          type: string
        metadata:
          type: object
          additionalProperties: true
          description: Event-specific data
        requestId:
          type: string
        sessionId:
          type: string

    BranchLineage:
      type: object
      required: [branchId, baseRef, baseCommit, divergedAt]
      properties:
        branchId:
          type: string
          format: uuid
        baseRef:
          type: string
          enum: [main, dev]
        baseCommit:
          type: string
          description: SHA of divergence point
        divergedAt:
          type: string
          format: date-time
        publishedCommit:
          type: string
          description: SHA of merge commit (if published)
        publishedAt:
          type: string
          format: date-time
        commitsAhead:
          type: integer
          description: Number of commits ahead of base
        commitsBehind:
          type: integer
          description: Number of commits behind base (base has advanced)

    UserSummary:
      type: object
      required: [id, displayName]
      properties:
        id:
          type: string
          format: uuid
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri

    Pagination:
      type: object
      required: [page, limit, total, totalPages]
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    Error:
      type: object
      required: [type, title, status, detail]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
