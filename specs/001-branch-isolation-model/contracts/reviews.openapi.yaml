openapi: 3.1.0
info:
  title: Branch Isolation Model - Reviews API
  version: 1.0.0
  description: API for managing reviews in the Echo Portal governed contribution workflow

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Reviews
    description: Review management operations
  - name: Comments
    description: Review comment operations

paths:
  /reviews:
    get:
      operationId: listReviews
      summary: List reviews
      description: Returns a paginated list of reviews for the authenticated user
      tags: [Reviews]
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/ReviewStatus'
          description: Filter by review status
        - name: role
          in: query
          schema:
            type: string
            enum: [reviewer, requester]
          description: Filter by user's role in the review
        - name: branchId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by branch
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of reviews
          content:
            application/json:
              schema:
                type: object
                required: [data, pagination]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReviewSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      operationId: requestReview
      summary: Request a review
      description: Submits a branch for review and assigns reviewers
      tags: [Reviews]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReviewRequest'
      responses:
        '201':
          description: Review requested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Branch not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Branch not in draft state or already in review
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /reviews/{reviewId}:
    parameters:
      - name: reviewId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: getReview
      summary: Get review details
      description: Returns detailed information about a specific review
      tags: [Reviews]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Review details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /reviews/{reviewId}/approve:
    parameters:
      - name: reviewId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      operationId: approveReview
      summary: Approve changes
      description: Approves the branch changes and transitions to approved state
      tags: [Reviews]
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                comment:
                  type: string
                  maxLength: 2000
                  description: Optional approval comment
      responses:
        '200':
          description: Review approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: User is not an assigned reviewer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Review not in pending/in_progress status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /reviews/{reviewId}/request-changes:
    parameters:
      - name: reviewId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      operationId: requestChanges
      summary: Request changes
      description: Requests changes to the branch, returning it to draft state
      tags: [Reviews]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  minLength: 10
                  maxLength: 2000
                  description: Explanation of requested changes
      responses:
        '200':
          description: Changes requested
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: User is not an assigned reviewer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Review not in pending/in_progress status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /reviews/{reviewId}/cancel:
    parameters:
      - name: reviewId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      operationId: cancelReview
      summary: Cancel review
      description: Cancels the review request, returning branch to draft state
      tags: [Reviews]
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  maxLength: 2000
      responses:
        '200':
          description: Review cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only branch owner can cancel review
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Review already completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /reviews/{reviewId}/comments:
    parameters:
      - name: reviewId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: listReviewComments
      summary: List review comments
      description: Returns all comments for a review
      tags: [Comments]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReviewComment'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      operationId: addReviewComment
      summary: Add a comment
      description: Adds a comment to the review
      tags: [Comments]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCommentRequest'
      responses:
        '201':
          description: Comment added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewComment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /reviews/{reviewId}/comments/{commentId}:
    parameters:
      - name: reviewId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: commentId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    patch:
      operationId: updateReviewComment
      summary: Update a comment
      description: Updates an existing comment (author only)
      tags: [Comments]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  minLength: 1
                  maxLength: 10000
      responses:
        '200':
          description: Comment updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewComment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Can only update own comments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      operationId: deleteReviewComment
      summary: Delete a comment
      description: Deletes a comment (author or admin only)
      tags: [Comments]
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Comment deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Can only delete own comments (or admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ReviewStatus:
      type: string
      enum: [pending, in_progress, completed, cancelled]
      description: Review status

    ReviewDecision:
      type: string
      enum: [approved, changes_requested]
      description: Review decision

    Review:
      type: object
      required:
        - id
        - branchId
        - reviewerId
        - requestedById
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        branchId:
          type: string
          format: uuid
        reviewerId:
          type: string
          format: uuid
        requestedById:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/ReviewStatus'
        decision:
          $ref: '#/components/schemas/ReviewDecision'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time

    ReviewSummary:
      allOf:
        - $ref: '#/components/schemas/Review'
        - type: object
          properties:
            branch:
              type: object
              required: [id, name, slug]
              properties:
                id:
                  type: string
                  format: uuid
                name:
                  type: string
                slug:
                  type: string
            reviewer:
              $ref: '#/components/schemas/UserSummary'
            requestedBy:
              $ref: '#/components/schemas/UserSummary'
            commentCount:
              type: integer

    ReviewDetail:
      allOf:
        - $ref: '#/components/schemas/ReviewSummary'
        - type: object
          properties:
            comments:
              type: array
              items:
                $ref: '#/components/schemas/ReviewComment'
            branchDiff:
              $ref: '#/components/schemas/BranchDiffSummary'

    ReviewComment:
      type: object
      required:
        - id
        - reviewId
        - authorId
        - content
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        reviewId:
          type: string
          format: uuid
        authorId:
          type: string
          format: uuid
        author:
          $ref: '#/components/schemas/UserSummary'
        content:
          type: string
        path:
          type: string
          description: File path for file-specific comments
        line:
          type: integer
          description: Line number for line-specific comments
        side:
          type: string
          enum: [left, right]
          description: Side of diff for line comments
        parentId:
          type: string
          format: uuid
          description: Parent comment ID for threaded replies
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateReviewRequest:
      type: object
      required: [branchId, reviewerIds]
      properties:
        branchId:
          type: string
          format: uuid
        reviewerIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 10
        message:
          type: string
          maxLength: 2000
          description: Message to reviewers

    CreateCommentRequest:
      type: object
      required: [content]
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 10000
        path:
          type: string
          description: File path for file-specific comments
        line:
          type: integer
          description: Line number for line-specific comments
        side:
          type: string
          enum: [left, right]
          description: Side of diff for line comments
        parentId:
          type: string
          format: uuid
          description: Parent comment ID for threaded replies

    UserSummary:
      type: object
      required: [id, displayName]
      properties:
        id:
          type: string
          format: uuid
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri

    BranchDiffSummary:
      type: object
      required: [additions, deletions, filesChanged]
      properties:
        additions:
          type: integer
        deletions:
          type: integer
        filesChanged:
          type: integer
        files:
          type: array
          items:
            type: object
            required: [path, status]
            properties:
              path:
                type: string
              status:
                type: string
                enum: [added, modified, deleted, renamed]

    Pagination:
      type: object
      required: [page, limit, total, totalPages]
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    Error:
      type: object
      required: [type, title, status, detail]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
