openapi: 3.1.0
info:
  title: Draft Sync API
  description: API contracts for inline edit draft synchronization
  version: 1.0.0

paths:
  /api/v1/contents/{contentId}/sync:
    post:
      operationId: syncDraft
      summary: Sync draft changes to server
      description: |
        Synchronizes local draft changes to the server. Uses optimistic concurrency
        control via `expectedServerVersion` to detect conflicts.

        **Conflict Handling:**
        - If `expectedServerVersion` matches current server version, creates new version
        - If versions don't match, returns 409 Conflict with server state for merge UI

        **Auto-save vs Manual Save:**
        - Auto-save: `changeDescription` = "Auto-saved draft"
        - Manual save: `changeDescription` = user-provided description
      tags:
        - Content
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: contentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Content UUID being synced
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftSyncInput'
            examples:
              autoSave:
                summary: Auto-save request
                value:
                  branchId: "550e8400-e29b-41d4-a716-446655440002"
                  body: "# Getting Started\n\nUpdated content here..."
                  expectedServerVersion: "2026-01-31T10:30:00.000Z"
                  changeDescription: "Auto-saved draft"
              manualSave:
                summary: Manual save with metadata
                value:
                  branchId: "550e8400-e29b-41d4-a716-446655440002"
                  title: "Getting Started Guide"
                  body: "# Getting Started\n\nComplete rewrite..."
                  metadata:
                    category: "guides"
                    tags: ["onboarding", "tutorial"]
                    description: "Beginner's guide to the platform"
                  expectedServerVersion: "2026-01-31T10:30:00.000Z"
                  changeDescription: "Reorganized structure and added examples"
      responses:
        '200':
          description: Draft synced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftSyncSuccessResponse'
              example:
                data:
                  success: true
                  newVersionTimestamp: "2026-01-31T10:35:00.000Z"
        '409':
          description: Version conflict - server has newer changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftSyncConflictResponse'
              example:
                data:
                  success: false
                  conflict:
                    serverVersionTimestamp: "2026-01-31T10:32:00.000Z"
                    serverVersionAuthor:
                      id: "550e8400-e29b-41d4-a716-446655440001"
                      displayName: "Another User"
                      avatarUrl: null
                    serverBody: "# Getting Started\n\nDifferent content..."
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to edit this content/branch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Content or branch not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/branches/edit:
    post:
      operationId: createEditBranch
      summary: Create a branch for editing published content
      description: |
        Creates a new branch forked from the main branch, copying the specified
        published content into the new branch for editing. This is the entry point
        for the "Edit" workflow from the Library view.

        **Workflow:**
        1. Validates source content exists and is published
        2. Creates new branch with draft state
        3. Copies content into the new branch
        4. Returns branch and content details for redirect to editor
      tags:
        - Branch
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditBranchCreateInput'
            example:
              sourceContentId: "550e8400-e29b-41d4-a716-446655440003"
              name: "Edit: Getting Started"
              slug: "edit-getting-started-lq2x8k"
      responses:
        '201':
          description: Branch created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EditBranchCreateResponse'
              example:
                data:
                  branch:
                    id: "550e8400-e29b-41d4-a716-446655440004"
                    name: "Edit: Getting Started"
                    slug: "edit-getting-started-lq2x8k"
                    state: "draft"
                    ownerId: "550e8400-e29b-41d4-a716-446655440001"
                    createdAt: "2026-01-31T10:40:00.000Z"
                  content:
                    id: "550e8400-e29b-41d4-a716-446655440005"
                    branchId: "550e8400-e29b-41d4-a716-446655440004"
                    title: "Getting Started"
                    slug: "getting-started"
                    contentType: "guideline"
                    currentVersion:
                      id: "550e8400-e29b-41d4-a716-446655440006"
                      versionTimestamp: "2026-01-31T10:40:00.000Z"
                      body: "# Getting Started\n\nOriginal content..."
                      changeDescription: "Forked from published version"
        '400':
          description: Invalid request body or slug already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to create branches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Source content not found or not published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: echo_session
      description: Session cookie (24-hour sliding expiry)
    bearerAuth:
      type: http
      scheme: bearer
      description: Bearer token for API access

  schemas:
    DraftSyncInput:
      type: object
      required:
        - branchId
        - body
        - changeDescription
      properties:
        branchId:
          type: string
          format: uuid
          description: Branch UUID context for the edit
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: Updated title (optional - only if changed)
        body:
          type: string
          maxLength: 52428800  # 50MB
          description: Full markdown body content
        metadata:
          type: object
          properties:
            category:
              type: string
              description: Content category
            tags:
              type: array
              items:
                type: string
              description: Content tags
            description:
              type: string
              maxLength: 500
              description: Content description/summary
        expectedServerVersion:
          type: string
          format: date-time
          nullable: true
          description: |
            Last known server version timestamp for conflict detection.
            Set to null for new content that hasn't been synced yet.
        changeDescription:
          type: string
          minLength: 1
          maxLength: 500
          description: Description of changes for version history

    DraftSyncSuccessResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          required:
            - success
            - newVersionTimestamp
          properties:
            success:
              type: boolean
              const: true
            newVersionTimestamp:
              type: string
              format: date-time
              description: Timestamp of the newly created version

    DraftSyncConflictResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          required:
            - success
            - conflict
          properties:
            success:
              type: boolean
              const: false
            conflict:
              type: object
              required:
                - serverVersionTimestamp
                - serverVersionAuthor
                - serverBody
              properties:
                serverVersionTimestamp:
                  type: string
                  format: date-time
                  description: Current server version timestamp
                serverVersionAuthor:
                  $ref: '#/components/schemas/UserSummary'
                serverBody:
                  type: string
                  description: Server version content for merge UI

    EditBranchCreateInput:
      type: object
      required:
        - sourceContentId
        - name
        - slug
      properties:
        sourceContentId:
          type: string
          format: uuid
          description: Published content UUID to fork
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Human-readable branch name
        slug:
          type: string
          pattern: '^[a-z0-9-]+$'
          minLength: 1
          maxLength: 100
          description: URL-safe branch slug (must be unique)

    EditBranchCreateResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          required:
            - branch
            - content
          properties:
            branch:
              $ref: '#/components/schemas/BranchSummary'
            content:
              $ref: '#/components/schemas/ContentDetail'

    UserSummary:
      type: object
      required:
        - id
        - displayName
      properties:
        id:
          type: string
          format: uuid
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
          nullable: true

    BranchSummary:
      type: object
      required:
        - id
        - name
        - slug
        - state
        - ownerId
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        state:
          type: string
          enum: [draft, review, approved, published, archived]
        ownerId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time

    ContentDetail:
      type: object
      description: Full content details including current version
      # Inherits from existing ContentDetail schema in content.ts

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              enum:
                - VALIDATION_ERROR
                - UNAUTHORIZED
                - FORBIDDEN
                - NOT_FOUND
                - CONFLICT
                - INTERNAL_ERROR
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              additionalProperties: true
              description: Additional error details

tags:
  - name: Content
    description: Content management operations
  - name: Branch
    description: Branch management operations
