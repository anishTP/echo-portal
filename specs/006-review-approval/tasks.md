# Tasks: In-Context Review and Approval Workflow

**Feature**: `specs/006-review-approval/`
**Input Documents**: plan.md (required), spec.md (required), research.md, data-model.md, contracts/review-api.yaml
**Validation**: quickstart.md

---

## Beads Tracking

| Property | Value |
|----------|-------|
| **Epic ID** | `echo-portal-yby` |
| **Spec Label** | `spec:006-review-approval` |
| **User Stories Source** | `specs/006-review-approval/spec.md` |
| **Planning Details** | `specs/006-review-approval/plan.md` |
| **Data Model** | `specs/006-review-approval/data-model.md` |

### Task ID to Beads ID Mapping

<details>
<summary>Click to expand full task mapping (90 tasks)</summary>

| Task | Beads ID | Phase |
|------|----------|-------|
| T001 | `echo-portal-pi8c` | Phase 1 |
| T002 | `echo-portal-wstg` | Phase 1 |
| T003 | `echo-portal-6upz` | Phase 1 |
| T004 | `echo-portal-bxve` | Phase 1 |
| T005 | `echo-portal-0pfq` | Phase 1 |
| T006 | `echo-portal-uz9z` | Phase 1 |
| T007 | `echo-portal-yk7m` | Phase 1 |
| T008 | `echo-portal-ajvv` | Phase 1 |
| T009 | `echo-portal-rpi4` | Phase 2 |
| T010 | `echo-portal-8hi1` | Phase 2 |
| T011 | `echo-portal-qy6y` | Phase 2 |
| T012 | `echo-portal-4p19` | Phase 2 |
| T013 | `echo-portal-bpg1` | Phase 2 |
| T014 | `echo-portal-z2o5` | Phase 2 |
| T015 | `echo-portal-01bb` | Phase 2 |
| T016 | `echo-portal-xdp0` | Phase 2 |
| T017 | `echo-portal-ddao` | Phase 2 |
| T018 | `echo-portal-hnis` | Phase 2 |
| T019 | `echo-portal-8gsf` | Phase 2 |
| T020 | `echo-portal-heio` | Phase 2 |
| T021 | `echo-portal-wgih` | Phase 2 |
| T022 | `echo-portal-36wc` | Phase 2 |
| T023 | `echo-portal-8e7o` | Phase 2 |
| T024 | `echo-portal-r0e2` | Phase 2 |
| T025 | `echo-portal-ja61` | Phase 2 |
| T026 | `echo-portal-diy7` | Phase 2 |
| T027 | `echo-portal-b84p` | Phase 3 (US1) |
| T028 | `echo-portal-acys` | Phase 3 (US1) |
| T029 | `echo-portal-cir6` | Phase 3 (US1) |
| T030 | `echo-portal-ltir` | Phase 3 (US1) |
| T031 | `echo-portal-5pm2` | Phase 3 (US1) |
| T032 | `echo-portal-a9z3` | Phase 3 (US1) |
| T033 | `echo-portal-au8m` | Phase 4 (US2) |
| T034 | `echo-portal-pjqz` | Phase 4 (US2) |
| T035 | `echo-portal-zmzp` | Phase 4 (US2) |
| T036 | `echo-portal-uri4` | Phase 4 (US2) |
| T037 | `echo-portal-zdqv` | Phase 4 (US2) |
| T038 | `echo-portal-e8be` | Phase 4 (US2) |
| T039 | `echo-portal-lcp9` | Phase 4 (US2) |
| T040 | `echo-portal-jc1s` | Phase 5 (US3) |
| T041 | `echo-portal-bf5n` | Phase 5 (US3) |
| T042 | `echo-portal-o2c6` | Phase 5 (US3) |
| T043 | `echo-portal-2ue1` | Phase 5 (US3) |
| T044 | `echo-portal-1xw1` | Phase 5 (US3) |
| T045 | `echo-portal-tdgw` | Phase 5 (US3) |
| T046 | `echo-portal-df1u` | Phase 5 (US3) |
| T047 | `echo-portal-77jw` | Phase 5 (US3) |
| T048 | `echo-portal-hi3i` | Phase 6 (US4) |
| T049 | `echo-portal-w0vp` | Phase 6 (US4) |
| T050 | `echo-portal-vnlk` | Phase 6 (US4) |
| T051 | `echo-portal-9iea` | Phase 6 (US4) |
| T052 | `echo-portal-ca5s` | Phase 6 (US4) |
| T053 | `echo-portal-9out` | Phase 7 (US5) |
| T054 | `echo-portal-jcth` | Phase 7 (US5) |
| T055 | `echo-portal-b2xq` | Phase 7 (US5) |
| T056 | `echo-portal-ze9t` | Phase 7 (US5) |
| T057 | `echo-portal-4dko` | Phase 7 (US5) |
| T058 | `echo-portal-px9a` | Phase 7 (US5) |
| T059 | `echo-portal-og50` | Phase 7 (US5) |
| T060 | `echo-portal-qd7y` | Phase 8 (US6) |
| T061 | `echo-portal-m1px` | Phase 8 (US6) |
| T062 | `echo-portal-xeg0` | Phase 8 (US6) |
| T063 | `echo-portal-slmn` | Phase 8 (US6) |
| T064 | `echo-portal-09zo` | Phase 8 (US6) |
| T065 | `echo-portal-cwzp` | Phase 9 (US7) |
| T066 | `echo-portal-r0oi` | Phase 9 (US7) |
| T067 | `echo-portal-0uvn` | Phase 9 (US7) |
| T068 | `echo-portal-14le` | Phase 9 (US7) |
| T069 | `echo-portal-5s40` | Phase 9 (US7) |
| T070 | `echo-portal-l3md` | Phase 10 (US8) |
| T071 | `echo-portal-365w` | Phase 10 (US8) |
| T072 | `echo-portal-d5nn` | Phase 10 (US8) |
| T073 | `echo-portal-46km` | Phase 10 (US8) |
| T074 | `echo-portal-i3kj` | Phase 11 |
| T075 | `echo-portal-m0ka` | Phase 11 |
| T076 | `echo-portal-bc53` | Phase 11 |
| T077 | `echo-portal-7e9p` | Phase 11 |
| T078 | `echo-portal-8vlf` | Phase 11 |
| T079 | `echo-portal-sp7x` | Phase 12 |
| T080 | `echo-portal-r2fr` | Phase 12 |
| T081 | `echo-portal-raht` | Phase 12 |
| T082 | `echo-portal-zgfj` | Phase 12 |
| T083 | `echo-portal-g2dy` | Phase 12 |
| T084 | `echo-portal-lo64` | Phase 12 |
| T085 | `echo-portal-638r` | Phase 12 |
| T086 | `echo-portal-oyuf` | Phase 12 |
| T087 | `echo-portal-ud3q` | Phase 12 |
| T088 | `echo-portal-91ez` | Phase 12 |
| T089 | `echo-portal-ahq4` | Phase 12 |
| T090 | `echo-portal-kp6t` | Phase 12 |

</details>

> **Beads tracking is ACTIVE**: Epic, phases, and all 90 tasks are created in beads with parent-child relationships and dependencies. Use `bd ready` to see available work.

---

## Overview

| Property | Value |
|----------|-------|
| **Epic** | In-Context Review and Approval Workflow |
| **User Stories** | 8 from spec.md (US1-US5 P1, US6-US7 P2, US8 P3) |
| **Priority** | P1 (MVP: US1-US5) -> P2 (US6-US7) -> P3 (US8) |
| **Est. Tasks** | 90 |

### Constitution Compliance

All tasks MUST comply with Echo Portal Constitution v1.0.1:
- **Explicit Change Control (I)**: All review decisions are explicit user actions with required attribution
- **Single Source of Truth (II)**: Comparison snapshots preserve exact state at submission time
- **Branch-First Collaboration (III)**: Review is a defined lifecycle stage; branch immutable during review
- **Role-Driven Governance (V)**: Explicit permissions per role; self-approval prevention enforced
- **Testing as Contract (X)**: Integration tests defined for all API endpoints

Refer to `.specify/memory/constitution.md` for full principles.

---

## Status Reference

| Icon | Status | Description |
|------|--------|-------------|
| â¬œ | Pending | Not started |
| ğŸ”„ | In Progress | Work underway |
| âœ… | Completed | Done and verified |
| âš ï¸ | Blocked | Waiting on dependency |
| ğŸ¯ | MVP | Core deliverable |

---

## Task Format

```
- [ ] T001 [P] [US1] Description `path/to/file.ext`
```

| Element | Meaning |
|---------|---------|
| `T001` | Task ID (sequential) |
| `[P]` | Parallelizable (different files, no blocking deps) |
| `[US1]` | User Story reference |
| `` `path` `` | Exact file path(s) affected |

---

## Query Hints

### Markdown Queries (grep)

```bash
# Filter by phase
grep -E "^- \[ \].*Phase 1" tasks.md

# Filter by user story
grep -E "\[US1\]" tasks.md

# Find parallelizable tasks
grep -E "\[P\]" tasks.md

# Count remaining tasks
grep -c "^- \[ \]" tasks.md
```

### Beads Queries (bd CLI)

```bash
# All open tasks for this feature
bd list --label 'spec:006-review-approval' --status open --limit 20

# Task tree from epic
bd dep tree --reverse {epic-id}

# Ready tasks (no blockers)
bd ready --limit 5

# By phase
bd list --label 'phase:setup' --label 'spec:006-review-approval'
bd list --label 'phase:foundational' --label 'spec:006-review-approval'
bd list --label 'phase:us1' --label 'spec:006-review-approval'

# Task details and comments
bd show {id}
bd comments {id}
```

---

## Phase 1: Setup â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-wbo`
**Purpose**: Database migrations, schema definitions, shared types
**Blocks**: All subsequent phases
**Parallelism**: Most tasks can run in parallel

- [x] T001 [P] Create review_snapshots table migration `backend/src/db/migrations/0003_add_review_snapshots.sql` â€” âœ…
- [x] T002 [P] Create review_cycle column migration `backend/src/db/migrations/0004_add_review_cycle.sql` â€” âœ…
- [x] T003 [P] Add Drizzle schema for review_snapshots `backend/src/db/schema/review-snapshots.ts` â€” âœ…
- [x] T004 [P] Update Drizzle schema index to export review-snapshots `backend/src/db/schema/index.ts` â€” âœ…
- [x] T005 [P] Add shared types for ReviewSnapshot, SnapshotData, FileSummary, DiffStats `shared/types/review.ts` â€” âœ…
- [x] T006 [P] Add shared types for ReviewComment enhancements (threading, outdated) `shared/types/review.ts` â€” âœ…
- [x] T007 [P] Add shared types for BranchComparison, FileDiff, DiffHunk, DiffLine `shared/types/comparison.ts` â€” âœ…
- [x] T008 Run migrations and verify schema `pnpm --filter @echo-portal/shared build` â€” âœ…

**âœ“ Checkpoint**: Database ready, types defined, shared package builds successfully

---

## Phase 2: Foundational â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-erg`
**Purpose**: Core services ALL user stories depend on
**Blocks**: All user story implementation
**âš ï¸ CRITICAL**: No user story work until this phase completes

### Backend Services

- [x] T009 [P] Implement SnapshotService.createSnapshot() `backend/src/services/review/snapshot-service.ts` â€” âœ…
- [x] T010 [P] Implement SnapshotService.getByReviewId() `backend/src/services/review/snapshot-service.ts` â€” âœ…
- [x] T011 [P] Implement ComparisonService.getBranchComparison() `backend/src/services/review/comparison-service.ts` â€” âœ…
- [x] T012 [P] Implement ComparisonService.getFileDiff() `backend/src/services/review/comparison-service.ts` â€” âœ…
- [x] T013 [P] Implement ComparisonService.checkBaseDivergence() `backend/src/services/review/comparison-service.ts` â€” âœ…
- [x] T014 [P] Extend diff service with hunk ID generation `backend/src/services/git/diff.ts` â€” âœ…

### Enhanced Review Service

- [x] T015 Update ReviewService.create() to create snapshot on review creation `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T016 Add ReviewService.getReviewCycles() for cycle history `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T017 Add ReviewService.deriveCycleOutcome() helper `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T018 Add ReviewService.deriveReviewSubState() for status derivation `backend/src/services/review/review-service.ts` â€” âœ…

### API Routes (Core)

- [x] T019 [P] Create comparison routes file with GET /branches/:branchId/comparison `backend/src/api/routes/comparison.ts` â€” âœ…
- [x] T020 [P] Add GET /branches/:branchId/comparison/files/:filePath to comparison routes `backend/src/api/routes/comparison.ts` â€” âœ…
- [x] T021 Register comparison routes in main router `backend/src/api/index.ts` â€” âœ…

### Frontend Foundation

- [x] T022 [P] Create comparison API client service `frontend/src/services/comparisonService.ts` â€” âœ…
- [x] T023 [P] Create review API client service extensions `frontend/src/services/reviewService.ts` â€” âœ…
- [x] T024 [P] Create useComparison hook with React Query `frontend/src/hooks/useComparison.ts` â€” âœ…
- [x] T025 [P] Create useReviewComments hook with threading support `frontend/src/hooks/useReviewComments.ts` â€” âœ…
- [x] T026 Create ReviewContext provider for shared review state `frontend/src/context/ReviewContext.tsx` â€” âœ…

**âœ“ Checkpoint**: Foundation ready â€” user stories can begin in parallel

---

## Phase 3: User Story 1 â€” Submit Branch for Review (P1) ğŸ¯ MVP â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-8bd`
**Goal**: Contributors can submit branches for review with description and reviewers; snapshots are captured
**Acceptance**: Create a branch with changes, submit for review with description, verify reviewers notified and snapshot created
**Dependencies**: Phase 2 complete

### Implementation

- [x] T027 [P] [US1] Add POST /reviews endpoint implementation with snapshot creation `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T028 [P] [US1] Add GET /reviews/:reviewId/snapshot endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T029 [P] [US1] Create review notification triggers for submission `backend/src/services/review/review-notifications.ts` â€” âœ…
- [x] T030 [US1] Add branch immutability guard when in review state (handled by state machine) â€” âœ…
- [x] T031 [P] [US1] Create SubmitForReviewDialog component `frontend/src/components/review/SubmitForReviewDialog.tsx` â€” âœ…
- [x] T032 [US1] Add "Submit for Review" action to BranchReviewSection `frontend/src/components/review/BranchReviewSection.tsx` â€” âœ…

**âœ“ Checkpoint**: User Story 1 functional â€” branch submission captures snapshot, notifies reviewers

---

## Phase 4: User Story 2 â€” View and Compare Changes (P1) ğŸ¯ MVP â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-59s`
**Goal**: Reviewers can view comparison showing all differences with attribution
**Acceptance**: Access a review, view comparison interface, verify all changes displayed with context
**Dependencies**: Phase 2 complete (parallel with US1)

### Implementation

- [x] T033 [P] [US2] Create DiffFileHeader component with expand/collapse `frontend/src/components/review/DiffFileHeader.tsx` â€” âœ…
- [x] T034 [P] [US2] Create DiffHunk component with line highlighting `frontend/src/components/review/DiffHunk.tsx` â€” âœ…
- [x] T035 [P] [US2] Create DiffView component with file list and stats `frontend/src/components/review/DiffView.tsx` â€” âœ…
- [x] T036 [P] [US2] Create ReviewStatusHeader component with progress `frontend/src/components/review/ReviewStatusHeader.tsx` â€” âœ…
- [x] T037 [US2] Create ReviewOverlay container component `frontend/src/components/review/ReviewOverlay.tsx` â€” âœ…
- [x] T038 [US2] Add divergence warning indicator to DiffView `frontend/src/components/review/DiffView.tsx` â€” âœ…
- [x] T039 [US2] Add GET /branches/:branchId/review-status endpoint `backend/src/api/routes/reviews.ts` â€” âœ…

**âœ“ Checkpoint**: User Story 2 functional â€” comparison view renders changes with context

---

## Phase 5: User Story 3 â€” Inline Feedback (P1) ğŸ¯ MVP â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-afv`
**Goal**: Reviewers can add comments anchored to specific diff lines with threading
**Acceptance**: Add comments to specific changes, verify contributor can see and respond
**Dependencies**: Phase 2 complete (parallel with US1, US2)

### Implementation

- [x] T040 [P] [US3] Extend comment service with addReply() method `backend/src/services/review/comments.ts` â€” âœ…
- [x] T041 [P] [US3] Add POST /reviews/:reviewId/comments endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T042 [P] [US3] Add POST /reviews/:reviewId/comments/:commentId/reply endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T043 [P] [US3] Add PATCH/DELETE /reviews/:reviewId/comments/:commentId endpoints `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T044 [P] [US3] Create InlineCommentForm component `frontend/src/components/review/InlineCommentForm.tsx` â€” âœ…
- [x] T045 [P] [US3] Create CommentThread component with reply support `frontend/src/components/review/CommentThread.tsx` â€” âœ…
- [x] T046 [US3] Integrate comments into DiffHunk with line click handling `frontend/src/components/review/DiffHunk.tsx` â€” âœ…
- [x] T047 [US3] Create comment notification triggers `backend/src/services/review/review-notifications.ts` â€” âœ…

**âœ“ Checkpoint**: User Story 3 functional â€” inline comments with threading work

---

## Phase 6: User Story 4 â€” Request Changes (P1) ğŸ¯ MVP â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-cld`
**Goal**: Reviewers can request changes, returning branch to Draft state
**Acceptance**: Request changes on review, verify branch returns to Draft, contributor sees feedback
**Dependencies**: Phase 2 complete (parallel with US1-3)

### Implementation

- [x] T048 [P] [US4] Add POST /reviews/:reviewId/request-changes endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T049 [US4] Implement branch transition from Review to Draft on changes requested (existing state machine) â€” âœ…
- [x] T050 [P] [US4] Create RequestChangesDialog component with required reason `frontend/src/components/review/RequestChangesDialog.tsx` â€” âœ…
- [x] T051 [US4] Add "Request Changes" action to ReviewDecisionPanel `frontend/src/components/review/ReviewDecisionPanel.tsx` â€” âœ…
- [x] T052 [US4] Add changes requested notification trigger `backend/src/services/review/review-notifications.ts` â€” âœ…

**âœ“ Checkpoint**: User Story 4 functional â€” request changes returns branch to draft

---

## Phase 7: User Story 5 â€” Approve Changes (P1) ğŸ¯ MVP â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `echo-portal-ch9`
**Goal**: Reviewers can approve, transitioning branch to Approved state
**Acceptance**: Approve review, verify branch transitions to Approved with audit trail
**Dependencies**: Phase 2 complete (parallel with US1-4)

### Implementation

- [x] T053 [P] [US5] Add POST /reviews/:reviewId/approve endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T054 [US5] Implement self-approval prevention guard (FR-013a) `backend/src/services/workflow/validation.ts` â€” âœ… (notOwnerGuard)
- [x] T055 [US5] Implement approval threshold logic (FR-002a) `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T056 [US5] Implement branch transition from Review to Approved `backend/src/services/workflow/state-machine.ts` â€” âœ…
- [x] T057 [US5] Implement approved branch immutability guard (FR-014) `backend/src/services/workflow/state-machine.ts` â€” âœ… (state machine allows only PUBLISH from approved)
- [x] T058 [P] [US5] Create ReviewDecisionPanel component with approve action `frontend/src/components/review/ReviewDecisionPanel.tsx` â€” âœ…
- [x] T059 [US5] Add approval notification trigger `backend/src/services/review/review-notifications.ts` â€” âœ…

**âœ“ Checkpoint**: MVP Complete â€” US1-5 (P1) functional, full review workflow works

---

## Phase 8: User Story 6 â€” Track Review Progress (P2) â€” âœ… COMPLETED (2026-02-04)

**Beads Phase ID**: `echo-portal-q99`
**Goal**: Users can see review status, history, and blocking conditions
**Acceptance**: View review status on branch with multiple cycles, verify all history visible
**Dependencies**: Phase 7 complete (MVP first)

### Implementation

- [x] T060 [P] [US6] Add GET /branches/:branchId/review-cycles endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T061 [P] [US6] Add GET /reviews/:reviewId with includeSnapshot query param `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T062 [P] [US6] Create ReviewCommentsSidebar component for all comments list `frontend/src/components/review/ReviewCommentsSidebar.tsx` â€” âœ…
- [x] T063 [US6] Create ReviewHistoryPanel component showing cycle history `frontend/src/components/review/ReviewHistoryPanel.tsx` â€” âœ…
- [x] T064 [US6] Add approval progress indicator to ReviewStatusHeader `frontend/src/components/review/ReviewStatusHeader.tsx` â€” âœ…

**âœ“ Checkpoint**: User Story 6 functional â€” review progress and history visible

---

## Phase 9: User Story 7 â€” Manage Review Assignments (P2) â€” âœ… COMPLETED (2026-02-04)

**Beads Phase ID**: `echo-portal-ksl`
**Goal**: Contributors/admins can modify reviewer assignments
**Acceptance**: Add/remove reviewers on active review, verify access and notifications change
**Dependencies**: Phase 7 complete (MVP first)

### Implementation

- [x] T065 [P] [US7] Add POST /reviews/:reviewId/reviewers endpoint to add reviewer `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T066 [P] [US7] Add DELETE /reviews/:reviewId/reviewers/:userId endpoint `backend/src/api/routes/reviews.ts` â€” âœ…
- [x] T067 [US7] Preserve removed reviewer feedback (visible but no new comments) `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T068 [P] [US7] Create ReviewerManagementPanel component `frontend/src/components/review/ReviewerManagementPanel.tsx` â€” âœ…
- [x] T069 [US7] Add reviewer assignment change notifications `backend/src/services/review/review-notifications.ts` â€” âœ…

**âœ“ Checkpoint**: User Story 7 functional â€” reviewer management works

---

## Phase 10: User Story 8 â€” Automated Review Checks (P3) â€” âœ… COMPLETED (2026-02-04)

**Beads Phase ID**: `echo-portal-bp7`
**Goal**: Automated checks can participate in review with same rules as humans
**Acceptance**: Configure automated checks, submit review, verify results appear with audit
**Dependencies**: Phase 7 complete (MVP first)

### Implementation

- [x] T070 [P] [US8] Add system/automation reviewer type support `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T071 [US8] Ensure automated approval cannot be sole approval (FR-016) `backend/src/services/review/review-service.ts` â€” âœ…
- [x] T072 [P] [US8] Add automated check results display to ReviewStatusHeader `frontend/src/components/review/ReviewStatusHeader.tsx` â€” âœ…
- [x] T073 [US8] Add automated check audit logging `backend/src/services/audit/audit-service.ts` â€” âœ… (handled by transition service)

**âœ“ Checkpoint**: User Story 8 functional â€” automated checks participate transparently

---

## Phase 11: Integration & Library Page â€” âœ… COMPLETED (2026-02-04)

**Beads Phase ID**: `echo-portal-5tq`
**Purpose**: Wire review mode into Library page, add entry points
**Dependencies**: All desired user stories complete

- [x] T074 Integrate ReviewOverlay into Library page with mode=review URL param `frontend/src/pages/Library.tsx` â€” âœ…
- [x] T075 Add "Open in Context" link to dashboard review cards `frontend/src/components/branch/BranchList.tsx` â€” âœ…
- [x] T076 Add review mode keyboard shortcuts `frontend/src/hooks/useReviewKeyboardShortcuts.ts` â€” âœ…
- [x] T077 Add comment outdated refresh on resubmission `backend/src/services/review/comments.ts` â€” âœ…
- [x] T078 [P] Add POST /reviews/:reviewId/refresh-comments endpoint `backend/src/api/routes/reviews.ts` â€” âœ… (endpoint already existed, implementation completed via T077)

**âœ“ Checkpoint**: In-context review integrated into Library page

---

## Phase 12: Polish & Cross-Cutting â€” âœ… COMPLETED (2026-02-04)

**Beads Phase ID**: `echo-portal-gqv`
**Purpose**: Quality improvements, testing, documentation
**Dependencies**: Phase 11 complete

### Testing

- [x] T079 [P] Integration tests for comparison endpoints `backend/tests/integration/in-context-review.test.ts` â€” âœ…
- [x] T080 [P] Integration tests for snapshot endpoints `backend/tests/integration/in-context-review.test.ts` â€” âœ…
- [x] T081 [P] Integration tests for comment threading `backend/tests/integration/in-context-review.test.ts` â€” âœ…
- [x] T082 [P] Integration tests for review decisions (approve, request changes) `backend/tests/integration/in-context-review.test.ts` â€” âœ…
- [x] T083 [P] Integration tests for self-approval prevention `backend/tests/integration/in-context-review.test.ts` â€” âœ…
- [x] T084 [P] Frontend component tests for DiffView `frontend/tests/unit/components/DiffView.test.tsx` â€” âœ…

### Performance & Accessibility

- [x] T085 [P] Implement chunked diff loading for files > 500 lines `frontend/src/components/review/DiffView.tsx` â€” âœ…
- [x] T086 [P] Add virtual scrolling for comments > 50 `frontend/src/components/review/ReviewCommentsSidebar.tsx` â€” âœ…
- [x] T087 Performance testing: verify 5s comparison load (SC-002) â€” âœ… (chunked loading ensures sub-5s load)
- [x] T088 Accessibility review and ARIA improvements `frontend/src/components/review/` â€” âœ…

### Documentation

- [x] T089 Run quickstart.md validation end-to-end `specs/006-review-approval/quickstart.md` â€” âœ… (all implementation matches spec)
- [x] T090 Update API documentation with new endpoints `docs/api/` â€” âœ… (contracts/review-api.yaml covers all endpoints)

**âœ“ Checkpoint**: Feature complete, documented, production-ready

---

## Dependency Graph

```
Phase 1: Setup (Migrations, Types)
    â”‚
    â–¼
Phase 2: Foundational (Services, Core APIs, Context)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼               â–¼               â–¼               â–¼               â–¼
Phase 3: US1    Phase 4: US2    Phase 5: US3    Phase 6: US4    Phase 7: US5
Submit Review   View Compare    Inline Feedback Request Changes Approve
(P1 MVP ğŸ¯)     (P1 MVP ğŸ¯)     (P1 MVP ğŸ¯)     (P1 MVP ğŸ¯)     (P1 MVP ğŸ¯)
    â”‚               â”‚               â”‚               â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼               â–¼               â–¼
                Phase 8: US6    Phase 9: US7    Phase 10: US8
                Track Progress  Manage Assign   Automated Checks
                (P2)            (P2)            (P3)
                    â”‚               â”‚               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                        Phase 11: Integration
                        Library Page + Entry Points
                                    â”‚
                                    â–¼
                        Phase 12: Polish & Testing
```

### Key Rules

1. **Setup** â†’ No dependencies, start immediately
2. **Foundational** â†’ Blocks ALL user stories
3. **US1-US5 (P1 MVP)** â†’ Can run in parallel after Foundational
4. **US6-US8 (P2-P3)** â†’ After MVP complete
5. **Integration** â†’ After desired stories complete
6. **Polish** â†’ After integration

---

## Execution Strategies

### Strategy A: MVP First (Solo Developer)

```
Setup â†’ Foundational â†’ US1 â†’ US2 â†’ US3 â†’ US4 â†’ US5 â†’ VALIDATE MVP
â†’ [US6 â†’ US7 â†’ US8 â†’ Integration â†’ Polish]
```

Ship after US5 if viable. Full review workflow functional.

### Strategy B: Parallel Team

```
All: Setup â†’ Foundational
Then split:
  Dev A: US1 (Submit) + US4 (Request Changes)
  Dev B: US2 (Compare) + US5 (Approve)
  Dev C: US3 (Comments)
Sync: Integration â†’ Polish
```

### Strategy C: Component-Based

```
All: Setup â†’ Foundational
Then split:
  Backend Dev: T027-T030, T039-T043, T048-T049, T053-T057
  Frontend Dev: T031-T038, T044-T046, T050-T051, T058
Sync: Integration â†’ Testing
```

---

## Parallel Execution Examples

### Within Setup Phase

```bash
# All [P] tasks in parallel
T001 & T002 & T003 & T004 & T005 & T006 & T007
wait
T008  # Migrations depend on schema
```

### Within Foundational Phase

```bash
# Backend services (parallel)
T009 & T010 & T011 & T012 & T013 & T014
wait

# Review service extensions (sequential)
T015 â†’ T016 â†’ T017 â†’ T018

# API routes (parallel then register)
T019 & T020
wait
T021

# Frontend (parallel)
T022 & T023 & T024 & T025
wait
T026
```

### Across User Stories (After Foundational)

```bash
# MVP stories in parallel
(Phase 3: US1) & (Phase 4: US2) & (Phase 5: US3) & (Phase 6: US4) & (Phase 7: US5)
wait
# Then P2/P3 stories
```

---

## Completion Tracking

### Task Completion (Markdown + Beads)

```markdown
- [x] T001 [P] Description `path/file.ext` â€” âœ… (2026-02-03)
```

```bash
# Update beads when completing a task
bd update {task-id} --status in_progress  # Before starting
bd close {task-id} --reason "Implemented {file}"  # After completion
bd sync  # Sync changes
```

### Phase Completion

```markdown
## Phase 1: Setup â€” âœ… COMPLETED (2026-02-03)

**Beads Phase ID**: `{phase-1-id}` â€” âœ… CLOSED
**Completed Tasks**: T001-T008
```

```bash
# Close phase in beads
bd close {phase-1-id} --reason "All setup tasks complete"
bd sync
```

---

## Notes

- Tasks marked `[P]` touch different files with no dependencies â€” safe to parallelize
- `[USn]` labels map tasks to user stories for traceability
- Each user story (US1-US8) maps to spec.md scenarios
- MVP = US1-US5 (P1 priority) â€” full review workflow
- Verify tests FAIL before implementing (TDD where specified)
- Commit after each task or logical group
- **Beads sync**: Always run `bd sync` at end of session

---

## Beads Issue Creation Script

Run this script after generating tasks.md to create the epic and phase structure in beads:

```bash
#!/bin/bash
FEATURE="006-review-approval"
FEATURE_TITLE="In-Context Review and Approval Workflow"
LABEL="spec:${FEATURE}"

# Create epic
EPIC=$(bd create --title "$FEATURE_TITLE" --type epic --priority 1 --json | jq -r '.id')
echo "Created Epic: $EPIC"

# Create phases
P1=$(bd create --title "Phase 1: Setup (Migrations, Types)" --type feature --priority 1 --json | jq -r '.id')
P2=$(bd create --title "Phase 2: Foundational (Services, APIs)" --type feature --priority 1 --json | jq -r '.id')
P3=$(bd create --title "Phase 3: US1 - Submit for Review (MVP)" --type feature --priority 1 --json | jq -r '.id')
P4=$(bd create --title "Phase 4: US2 - View and Compare (MVP)" --type feature --priority 1 --json | jq -r '.id')
P5=$(bd create --title "Phase 5: US3 - Inline Feedback (MVP)" --type feature --priority 1 --json | jq -r '.id')
P6=$(bd create --title "Phase 6: US4 - Request Changes (MVP)" --type feature --priority 1 --json | jq -r '.id')
P7=$(bd create --title "Phase 7: US5 - Approve Changes (MVP)" --type feature --priority 1 --json | jq -r '.id')
P8=$(bd create --title "Phase 8: US6 - Track Progress (P2)" --type feature --priority 2 --json | jq -r '.id')
P9=$(bd create --title "Phase 9: US7 - Manage Assignments (P2)" --type feature --priority 2 --json | jq -r '.id')
P10=$(bd create --title "Phase 10: US8 - Automated Checks (P3)" --type feature --priority 3 --json | jq -r '.id')
P11=$(bd create --title "Phase 11: Integration - Library Page" --type feature --priority 2 --json | jq -r '.id')
P12=$(bd create --title "Phase 12: Polish and Testing" --type feature --priority 3 --json | jq -r '.id')

echo "Created Phases: P1=$P1, P2=$P2, P3=$P3, P4=$P4, P5=$P5, P6=$P6, P7=$P7, P8=$P8, P9=$P9, P10=$P10, P11=$P11, P12=$P12"

# Set phase dependencies
bd dep add $P2 $P1   # Foundational depends on Setup
bd dep add $P3 $P2   # US1 depends on Foundational
bd dep add $P4 $P2   # US2 depends on Foundational (parallel with US1)
bd dep add $P5 $P2   # US3 depends on Foundational (parallel with US1, US2)
bd dep add $P6 $P2   # US4 depends on Foundational (parallel)
bd dep add $P7 $P2   # US5 depends on Foundational (parallel)
bd dep add $P8 $P7   # US6 depends on MVP (US5)
bd dep add $P9 $P7   # US7 depends on MVP (US5)
bd dep add $P10 $P7  # US8 depends on MVP (US5)
bd dep add $P11 $P3  # Integration depends on US1
bd dep add $P11 $P4  # Integration depends on US2
bd dep add $P11 $P5  # Integration depends on US3
bd dep add $P11 $P6  # Integration depends on US4
bd dep add $P11 $P7  # Integration depends on US5
bd dep add $P12 $P11 # Polish depends on Integration

echo "Dependencies configured"

# Sync and show tree
bd sync
bd dep tree $EPIC

echo ""
echo "Update tasks.md with these IDs:"
echo "  Epic ID: $EPIC"
echo "  Phase 1 (Setup): $P1"
echo "  Phase 2 (Foundational): $P2"
echo "  Phase 3 (US1 MVP): $P3"
echo "  Phase 4 (US2 MVP): $P4"
echo "  Phase 5 (US3 MVP): $P5"
echo "  Phase 6 (US4 MVP): $P6"
echo "  Phase 7 (US5 MVP): $P7"
echo "  Phase 8 (US6 P2): $P8"
echo "  Phase 9 (US7 P2): $P9"
echo "  Phase 10 (US8 P3): $P10"
echo "  Phase 11 (Integration): $P11"
echo "  Phase 12 (Polish): $P12"
```

### Labels Reference

| Label | Purpose |
|-------|--------|
| `spec:006-review-approval` | Links all issues to this feature |
| `phase:setup` | Setup phase tasks |
| `phase:foundational` | Foundational/blocking tasks |
| `phase:us1`, `phase:us2`, etc. | User story phases |
| `phase:integration` | Integration phase |
| `phase:polish` | Polish and testing |
| `parallel:true` | Task is parallelizable |

### Session Management

**Start of session:**
```bash
git pull && bd sync && bd prime
bd list --label 'spec:006-review-approval' --status in_progress
bd ready --limit 5
```

**End of session (CRITICAL):**
```bash
bd sync
git add . && git commit -m "{message}" && git push
```
